<!-- Add this macro at the top -->
{% macro render_field_errors(field_name) %}
    {% if form_errors and field_name in form_errors %}
        <div class="invalid-feedback d-block">
            {{ form_errors[field_name]|join(', ') }}
        </div>
    {% endif %}
{% endmacro %}

<div class="mobile-form">
    <div class="help-text mb-3">
        <strong>Valid inputs:</strong>
        <ul>
            <li>Score (-40 to 80)</li>
            <li>H = Hauki (0 points)</li>
            <li>F = Fault (0 points)</li>
            <li>E = Empty/Unused (1 point)</li>
        </ul>
    </div>

    <div class="draft-controls">
        <button type="button" class="btn btn-secondary" onclick="saveDraft()">
            {{ _('Save Draft') }}
        </button>
        <button type="button" class="btn btn-secondary" onclick="loadDraft()">
            {{ _('Load Draft') }}
        </button>
        <button type="button" class="btn btn-danger" onclick="clearDraft()">
            {{ _('Clear Draft') }}
        </button>
    </div>

    <div class="mobile-tabs">
        <button type="button"  class="tab-button active" onclick="showTab('round1')">{{ _('Round 1') }}</button>
        <button type="button" class="tab-button" onclick="showTab('round2')">{{ _('Round 2') }}</button>
        <button type="button" class="tab-button" onclick="showTab('scores')">{{ _('Scores') }}</button>
    </div>

    <div id="round1" class="tab-content active" tabindex="-1">
        {% for team_num in [1, 2] %}
            <div class="team-section">
                <h3>{{ _('Team') }} {{ team_num }}</h3>
                {% for player_index in range(4) %}
                    {% set throw_form = form['team_' ~ team_num ~ '_round_throws'].entries[0] %}
                    {% set single_throw = throw_form['round_1'].entries[player_index] %}
                    <div class="player-throws">
                        <select name="{{ single_throw.player_id.name }}" class="player-select" required>
                            {% for value, label in single_throw.player_id.choices %}
                                <option value="{{ value }}" {% if value == single_throw.player_id.data %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="throw-inputs">
                            {% for i in range(1, 5) %}
                                <div class="throw-input-container">
                                    <input type="text" 
                                           name="{{ single_throw['throw_' ~ i].name }}"
                                           value="{{ single_throw['throw_' ~ i].data if single_throw['throw_' ~ i].data is not none else '' }}"
                                           class="form-control throw-input {% if single_throw['throw_' ~ i].errors %}is-invalid{% endif %}"
                                           required
                                           tabindex="0">
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="{{ single_throw.game_set_index.name }}" value="1">
                        <input type="hidden" name="{{ single_throw.throw_position.name }}" value="{{ player_index + 1 }}">
                        <input type="hidden" name="{{ single_throw.home_team.name }}" value="{{ 'true' if team_num == 1 else 'false' }}">
                        {{ single_throw.hidden_tag() if single_throw.hidden_tag }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <div id="round2" class="tab-content" tabindex="-1">
        {% for team_num in [1, 2] %}
            <div class="team-section">
                <h3>{{ _('Team') }} {{ team_num }}</h3>
                {% for player_index in range(4) %}
                    {% set throw_form = form['team_' ~ team_num ~ '_round_throws'].entries[0] %}
                    {% set single_throw = throw_form['round_2'].entries[player_index] %}
                    <div class="player-throws">
                        <select name="{{ single_throw.player_id.name }}" class="player-select" required>
                            {% for value, label in single_throw.player_id.choices %}
                                <option value="{{ value }}" {% if value == single_throw.player_id.data %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="throw-inputs">
                            {% for i in range(1, 5) %}
                                <div class="throw-input-container">
                                    <input type="text" 
                                           name="{{ single_throw['throw_' ~ i].name }}"
                                           value="{{ single_throw['throw_' ~ i].data if single_throw['throw_' ~ i].data is not none else '' }}"
                                           class="form-control throw-input {% if single_throw['throw_' ~ i].errors %}is-invalid{% endif %}"
                                           required
                                           tabindex="0">
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="{{ single_throw.game_set_index.name }}" value="2">
                        <input type="hidden" name="{{ single_throw.throw_position.name }}" value="{{ player_index + 1 }}">
                        <input type="hidden" name="{{ single_throw.home_team.name }}" value="{{ 'true' if team_num == 1 else 'false' }}">
                        {{ single_throw.hidden_tag() if single_throw.hidden_tag }}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <div id="scores" class="tab-content" tabindex="-1">
        <div class="score-section">
            <h3>{{ _('Round 1') }}</h3>
            <div class="score-inputs">
                <div>
                    <label>{{ _('Team 1') }}</label>
                    <input type="number" 
                           name="{{ form.score_1_1.name }}"
                           value="{{ form.score_1_1.data if form.score_1_1.data is not none else '' }}"
                           class="score-input {% if form.score_1_1.errors %}is-invalid{% endif %}"
                           min="{{ game_constants.ROUND_SCORE_MIN }}"
                           max="{{ game_constants.ROUND_SCORE_MAX }}"
                           onchange="validateAndCalculateTotalScores(this, GAME_SCORES)"
                           tabindex="0">
                </div>
                <div>
                    <label>{{ _('Team 2') }}</label>
                    <input type="number" 
                           name="{{ form.score_2_1.name }}"
                           value="{{ form.score_2_1.data if form.score_2_1.data is not none else '' }}"
                           class="score-input {% if form.score_2_1.errors %}is-invalid{% endif %}"
                           min="{{ game_constants.ROUND_SCORE_MIN }}"
                           max="{{ game_constants.ROUND_SCORE_MAX }}"
                           onchange="validateAndCalculateTotalScores(this, GAME_SCORES)"
                           tabindex="0">
                </div>
            </div>

            <h3>{{ _('Round 2') }}</h3>
            <div class="score-inputs">
                <div>
                    <label>{{ _('Team 1') }}</label>
                    <input type="number" 
                           name="{{ form.score_1_2.name }}"
                           value="{{ form.score_1_2.data if form.score_1_2.data is not none else '' }}"
                           class="score-input {% if form.score_1_2.errors %}is-invalid{% endif %}"
                           min="{{ game_constants.ROUND_SCORE_MIN }}"
                           max="{{ game_constants.ROUND_SCORE_MAX }}"
                           onchange="validateAndCalculateTotalScores(this, GAME_SCORES)"
                           tabindex="0">
                </div>
                <div>
                    <label>{{ _('Team 2') }}</label>
                    <input type="number" 
                           name="{{ form.score_2_2.name }}"
                           value="{{ form.score_2_2.data if form.score_2_2.data is not none else '' }}"
                           class="score-input {% if form.score_2_2.errors %}is-invalid{% endif %}"
                           min="{{ game_constants.ROUND_SCORE_MIN }}"
                           max="{{ game_constants.ROUND_SCORE_MAX }}"
                           onchange="validateAndCalculateTotalScores(this, GAME_SCORES)"
                           tabindex="0">
                </div>
            </div>

            <h3>{{ _('Final Scores') }}</h3>
            <div class="final-scores">
                <div>
                    <label>{{ _('Team 1 Total') }}</label>
                    <span id="team1-total">{{ form.end_score_team_1.data }}</span>
                </div>
                <div>
                    <label>{{ _('Team 2 Total') }}</label>
                    <span id="team2-total">{{ form.end_score_team_2.data }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this fixed bottom save button -->
    <div class="mobile-save-button">
        <button type="submit" class="btn btn-primary btn-lg btn-block">
            {{ _('Save Game') }}
        </button>
    </div>
</div>