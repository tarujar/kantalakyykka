{% extends 'admin/model/edit.html' %}

{% block head %}
    {{ super() }}
    <script>
        function autoFillForm() {
            // Set teams if they exist
            const team1Select = document.querySelector('select[name="team_1_id"]');
            const team2Select = document.querySelector('select[name="team_2_id"]');

            if (team1Select && team1Select.options.length > 0) {
                team1Select.selectedIndex = 1;  // Select first actual team
            }

            if (team2Select && team2Select.options.length > 0) {
                team2Select.selectedIndex = 2;  // Select second actual team
            }

            // Auto-fill throw values
            const possibleThrows = [-1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];  // Valid throw values
            const throwInputs = document.querySelectorAll('input[name*="throw_"]');
            
            throwInputs.forEach(input => {
                const randomIndex = Math.floor(Math.random() * possibleThrows.length);
                input.value = possibleThrows[randomIndex];
            });

            // Auto-fill player selections
            const playerSelects = document.querySelectorAll('select[name*="player_id"]');
            playerSelects.forEach(select => {
                if (select.options.length > 0) {
                    const randomIndex = Math.floor(Math.random() * (select.options.length - 1)) + 1;
                    select.selectedIndex = randomIndex;
                }
            });
        }

        function toggleForm() {
            const desktopForm = document.querySelector('.desktop-form');
            const mobileForm = document.querySelector('.mobile-form');
            const toggleButton = document.querySelector('#toggleFormButton');
            const formTypeInput = document.querySelector('input[name="form_type"]');

            // Sync form data before switching
            if (desktopForm.style.display === 'none') {
                // Switching to desktop - sync mobile to desktop
                syncFormData('.mobile-form', '.desktop-form');
                desktopForm.style.display = 'block';
                mobileForm.style.display = 'none';
                toggleButton.textContent = '{{ _("Switch to Mobile Form") }}';
                formTypeInput.value = 'desktop';
            } else {
                // Switching to mobile - sync desktop to mobile
                syncFormData('.desktop-form', '.mobile-form');
                desktopForm.style.display = 'none';
                mobileForm.style.display = 'block';
                toggleButton.textContent = '{{ _("Switch to Desktop Form") }}';
                formTypeInput.value = 'mobile';
            }
        }

        function syncFormData(sourceFormSelector, targetFormSelector) {
            const sourceForm = document.querySelector(sourceFormSelector);
            const targetForm = document.querySelector(targetFormSelector);

            // Sync all input fields
            sourceForm.querySelectorAll('input[name], select[name]').forEach(sourceInput => {
                const inputName = sourceInput.getAttribute('name');
                const targetInput = targetForm.querySelector(`[name="${inputName}"]`);
                if (targetInput) {
                    targetInput.value = sourceInput.value;
                }
            });
        }

        function adjustMobileFormLayout(gameType, throwRoundAmount) {
            const mobileForm = document.querySelector('.mobile-form');

            if (!mobileForm) return;

            // Adjust the form layout based on the game type
            if (gameType === 'single') {
                // Example: Single game type
                mobileForm.classList.add('single-game-layout');
                mobileForm.classList.remove('team-game-layout');
            } else {
                // Example: Team game type
                mobileForm.classList.add('team-game-layout');
                mobileForm.classList.remove('single-game-layout');
            }

            // Adjust the form layout based on the throw round amount
            const roundHeaders = mobileForm.querySelectorAll('.round-header');
            roundHeaders.forEach((header, index) => {
                if (index < throwRoundAmount) {
                    header.style.display = 'block';
                } else {
                    header.style.display = 'none';
                }
            });

            const singleThrowForms = mobileForm.querySelectorAll('.single-throw-form');
            singleThrowForms.forEach((form, index) => {
                if (index < throwRoundAmount * 8) {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            });
        }

        const DRAFT_KEY = 'gameScoreSheetDraft_' + '{{ request.args.get("id", "") }}';

        function saveDraft() {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            const draftData = {};
            
            for (const [key, value] of formData.entries()) {
                draftData[key] = value;
            }
            
            localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
            showToast('Draft saved successfully');
        }

        function loadDraft() {
            const draftData = localStorage.getItem(DRAFT_KEY);
            if (!draftData) {
                showToast('No draft found');
                return;
            }

            const data = JSON.parse(draftData);
            const form = document.querySelector('form');
            
            for (const [key, value] of Object.entries(data)) {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = value;
                }
            }
            
            showToast('Draft loaded successfully');
        }

        function clearDraft() {
            if (confirm('Are you sure you want to clear the draft?')) {
                localStorage.removeItem(DRAFT_KEY);
            }
        }

        function showTab(tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Add active class to clicked button
            const selectedButton = document.querySelector(`.tab-button[onclick*="${tabId}"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // Save last active tab to localStorage
            localStorage.setItem('lastActiveTab', tabId);
        }

        function calculateTotalScores() {
            // Get score inputs
            const score11 = parseInt(document.querySelector('input[name="score_1_1"]').value) || 0;
            const score12 = parseInt(document.querySelector('input[name="score_1_2"]').value) || 0;
            const score21 = parseInt(document.querySelector('input[name="score_2_1"]').value) || 0;
            const score22 = parseInt(document.querySelector('input[name="score_2_2"]').value) || 0;

            // Calculate totals
            const team1Total = score11 + score12;
            const team2Total = score21 + score22;

            // Update total score displays
            document.querySelector('#team1-total').textContent = team1Total;
            document.querySelector('#team2-total').textContent = team2Total;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(event) {
                    // Get the active form (mobile or desktop)
                    const activeForm = document.querySelector('.mobile-form').style.display === 'none' 
                        ? '.desktop-form' 
                        : '.mobile-form';
                    
                    // Sync the active form's data to the other form before submission
                    const inactiveForm = activeForm === '.desktop-form' ? '.mobile-form' : '.desktop-form';
                    syncFormData(activeForm, inactiveForm);

                    // Log form submission for debugging
                    console.log('Form submission started from ' + activeForm);
                    const formData = new FormData(form);
                    for (const [key, value] of formData.entries()) {
                        console.log(`${key}: ${value}`);
                    }
                });
            }

            // Initialize form visibility
            const desktopForm = document.querySelector('.desktop-form');
            const mobileForm = document.querySelector('.mobile-form');
            const toggleButton = document.querySelector('#toggleFormButton');
            const formTypeInput = document.querySelector('input[name="form_type"]');

            if (window.innerWidth <= 768) {
                desktopForm.style.display = 'none';
                mobileForm.style.display = 'block';
                toggleButton.textContent = '{{ _("Switch to Desktop Form") }}';
                formTypeInput.value = 'mobile';
            } else {
                desktopForm.style.display = 'block';
                mobileForm.style.display = 'none';
                toggleButton.textContent = '{{ _("Switch to Mobile Form") }}';
                formTypeInput.value = 'desktop';
            }

            // Adjust mobile form layout based on the game type and throw round amount
            adjustMobileFormLayout('{{ game_type }}', '{{ throw_round_amount }}');

            // Restore last active tab
            const lastActiveTab = localStorage.getItem('lastActiveTab');
            if (lastActiveTab) {
                showTab(lastActiveTab);
            }

            // Add change event listeners to score inputs
            const scoreInputs = document.querySelectorAll('.score-input');
            scoreInputs.forEach(input => {
                input.addEventListener('change', calculateTotalScores);
            });
        });
    </script>
{% endblock %}

{% block edit_form %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <form action="" method="POST" role="form" class="admin-form" enctype="multipart/form-data">
                    {{ form.hidden_tag() if form.hidden_tag }}
                    <input type="hidden" name="form_type" value="desktop">
                    
                    <div class="form-actions mb-3">
                        <button type="button" class="btn btn-secondary" onclick="autoFillForm()">
                            {{ _('Auto-fill Test Data') }}
                        </button>
                        <button type="button" class="btn btn-secondary" id="toggleFormButton" onclick="toggleForm()">
                            {{ _('Switch to Mobile Form') }}
                        </button>
                    </div>

                    <!-- Include desktop form -->
                    {% include 'admin/partials/desktop_form.html' %}

                    <!-- Include mobile form -->
                    {% include 'admin/partials/mobile_form.html' %}

                    <div class="form-actions mt-3">
                        <input type="submit" class="btn btn-primary" value="{{ _('Save') }}" />
                        <a href="{{ return_url }}" class="btn btn-default">{{ _('Cancel') }}</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block tail %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(event) {
                    // Get the active form (mobile or desktop)
                    const activeForm = document.querySelector('.mobile-form').style.display === 'none' 
                        ? '.desktop-form' 
                        : '.mobile-form';
                    
                    // Sync the active form's data to the other form before submission
                    const inactiveForm = activeForm === '.desktop-form' ? '.mobile-form' : '.desktop-form';
                    syncFormData(activeForm, inactiveForm);

                    // Log form submission for debugging
                    console.log('Form submission started from ' + activeForm);
                    const formData = new FormData(form);
                    for (const [key, value] of formData.entries()) {
                        console.log(`${key}: ${value}`);
                    }
                });
            }

            // Initialize form visibility
            const desktopForm = document.querySelector('.desktop-form');
            const mobileForm = document.querySelector('.mobile-form');
            const toggleButton = document.querySelector('#toggleFormButton');
            const formTypeInput = document.querySelector('input[name="form_type"]');

            if (window.innerWidth <= 768) {
                desktopForm.style.display = 'none';
                mobileForm.style.display = 'block';
                toggleButton.textContent = '{{ _("Switch to Desktop Form") }}';
                formTypeInput.value = 'mobile';
            } else {
                desktopForm.style.display = 'block';
                mobileForm.style.display = 'none';
                toggleButton.textContent = '{{ _("Switch to Mobile Form") }}';
                formTypeInput.value = 'desktop';
            }

            // Adjust mobile form layout based on the game type and throw round amount
            adjustMobileFormLayout('{{ game_type }}', '{{ throw_round_amount }}');

            // Restore last active tab
            const lastActiveTab = localStorage.getItem('lastActiveTab');
            if (lastActiveTab) {
                showTab(lastActiveTab);
            }

            // Add change event listeners to score inputs
            const scoreInputs = document.querySelectorAll('.score-input');
            scoreInputs.forEach(input => {
                input.addEventListener('change', calculateTotalScores);
            });
        });
    </script>
{% endblock %}

<style>
    .container-fluid {
        padding: 20px;
    }
    
    .admin-form {
        background-color: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .game-score-sheet-table {
        width: 100%;
        margin-bottom: 1rem;
        background-color: transparent;
    }

    .game-score-sheet-table th,
    .game-score-sheet-table td {
        padding: 0.75rem;
        vertical-align: middle;
    }

    .form-actions {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }

    .single-throw-form {
        margin-bottom: 10px;
    }
    .form-actions {
        margin: 20px 0;
    }
    .game-score-sheet-table td {
        padding: 8px;
    }
    .round-header {
        background-color: #f0f0f0;
        font-weight: bold;
        text-align: center;
    }
    .round-score {
        background-color: #e0e0e0;
        font-weight: bold;
        text-align: center;
    }
    .end-score {
        background-color: #d0d0d0;
        font-weight: bold;
        text-align: center;
    }
    input[type="number"] {
        width: 80px;
    }
</style>
